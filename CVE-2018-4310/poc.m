#import <Foundation/Foundation.h>
#include <dlfcn.h>
#define MEDIA_REMOTE "/System/Library/PrivateFrameworks/MediaRemote.framework/MediaRemote"

__attribute__((constructor)) void entry() {

  void *handle = dlopen(MEDIA_REMOTE, RTLD_GLOBAL | RTLD_NOW);
  typedef id (*client_create_t)(NSNumber *, NSString *);
  typedef id (*remote_send_cmd_to_client_t)(int, NSDictionary *, id, id, int, int, id);
  client_create_t MRNowPlayingClientCreate = (client_create_t)dlsym(handle, "MRNowPlayingClientCreate");
  id client = MRNowPlayingClientCreate(nil, @"com.apple.calculator");
  remote_send_cmd_to_client_t MRMediaRemoteSendCommandToClient =
      (remote_send_cmd_to_client_t)dlsym(handle, "MRMediaRemoteSendCommandToClient");
  NSDictionary *args = @{@"kMRMediaRemoteOptionDisableImplicitAppLaunchBehaviors" : @0};
  dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
  MRMediaRemoteSendCommandToClient(2, args, nil, client, 1, 0, ^void(unsigned int arg2, CFArrayRef arg3) {
    // still don't know why this callback never get called
    NSLog(@"bye %uld %@", arg2, arg3);
    dispatch_semaphore_signal(semaphore);
  });
  dispatch_semaphore_wait(semaphore, dispatch_time(DISPATCH_TIME_NOW, (int64_t)(NSEC_PER_MSEC)));
}
